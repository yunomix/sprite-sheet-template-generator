var W=Object.defineProperty;var z=(o,t,i)=>t in o?W(o,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):o[t]=i;var g=(o,t,i)=>z(o,typeof t!="symbol"?t+"":t,i);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))e(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const r of n.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&e(r)}).observe(document,{childList:!0,subtree:!0});function i(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function e(s){if(s.ep)return;s.ep=!0;const n=i(s);fetch(s.href,n)}})();class C{constructor(t,i){g(this,"canvas");g(this,"ctx");this.canvas=document.createElement("canvas"),this.canvas.width=t,this.canvas.height=i;const e=this.canvas.getContext("2d");if(!e)throw new Error("Failed to get 2D context");this.ctx=e}static fromCanvas(t){const i=new C(t.width,t.height);i.canvas=t;const e=t.getContext("2d");if(!e)throw new Error("Failed to get 2D context");return i.ctx=e,i}static async fromImage(t){const i=new C(t.width,t.height);return i.ctx.drawImage(t,0,0),i}static async loadImage(t){return new Promise((i,e)=>{const s=new Image;s.onload=()=>i(s),s.onerror=e,s.src=t})}getCanvas(){return this.canvas}getContext(){return this.ctx}getWidth(){return this.canvas.width}getHeight(){return this.canvas.height}clear(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}fill(t){this.ctx.fillStyle=this.colorToString(t),this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)}fillRect(t,i){this.ctx.fillStyle=this.colorToString(i),this.ctx.fillRect(t.x,t.y,t.width,t.height)}strokeRect(t,i,e){this.ctx.strokeStyle=this.colorToString(i),this.ctx.lineWidth=e,this.ctx.strokeRect(t.x+e/2,t.y+e/2,t.width-e,t.height-e)}drawLine(t,i,e,s,n,r){this.ctx.strokeStyle=this.colorToString(n),this.ctx.lineWidth=r,this.ctx.beginPath(),this.ctx.moveTo(t,i),this.ctx.lineTo(e,s),this.ctx.stroke()}drawImage(t,i,e,s,n,r,c,a,l){const d=t instanceof C?t.getCanvas():t;this.ctx.drawImage(d,i,e,s,n,r,c,a,l)}getImageData(t){return t?this.ctx.getImageData(t.x,t.y,t.width,t.height):this.ctx.getImageData(0,0,this.canvas.width,this.canvas.height)}putImageData(t,i,e){this.ctx.putImageData(t,i,e)}getPixel(t,i){const e=this.ctx.getImageData(t,i,1,1).data;return{r:e[0],g:e[1],b:e[2],a:e[3]}}setPixel(t,i,e){const s=this.ctx.createImageData(1,1);s.data[0]=e.r,s.data[1]=e.g,s.data[2]=e.b,s.data[3]=e.a,this.ctx.putImageData(s,t,i)}detectContentBounds(t,i=10){const s=this.getImageData(t).data,n=t.width,r=t.height;let c=n,a=r,l=0,d=0,h=!1;for(let x=0;x<r;x++)for(let v=0;v<n;v++){const u=(x*n+v)*4;s[u+3]>i&&(h=!0,v<c&&(c=v),x<a&&(a=x),v>l&&(l=v),x>d&&(d=x))}return h?{minX:c,minY:a,maxX:l,maxY:d}:null}drawResized(t,i,e){this.ctx.drawImage(t.getCanvas(),i.x,i.y,i.width,i.height,e.x,e.y,e.width,e.height)}toDataURL(t="image/png"){return this.canvas.toDataURL(t)}toBlob(t="image/png"){return new Promise((i,e)=>{this.canvas.toBlob(s=>{s?i(s):e(new Error("Failed to create blob"))},t)})}downloadAsFile(t){const i=document.createElement("a");i.download=t,i.href=this.toDataURL(),i.click()}clone(){const t=new C(this.canvas.width,this.canvas.height);return t.ctx.drawImage(this.canvas,0,0),t}resize(t,i){const e=new C(t,i);return e.ctx.drawImage(this.canvas,0,0,t,i),e}colorToString(t){return`rgba(${t.r}, ${t.g}, ${t.b}, ${t.a/255})`}static hexToColor(t){const i=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return i?{r:parseInt(i[1],16),g:parseInt(i[2],16),b:parseInt(i[3],16),a:255}:{r:0,g:0,b:0,a:255}}static colorToHex(t){const i=e=>e.toString(16).padStart(2,"0");return`#${i(t.r)}${i(t.g)}${i(t.b)}`}}const F=[0,2,10,8,4,6,14,12,5,7,15,13,1,3,11,9];function X(){const o=[];for(let t=0;t<16;t++)o.push(F[t]);return o.push(79),o.push(143),o.push(47),o.push(31),o.push(63),o.push(207),o.push(159),o.push(111),o.push(95),o.push(175),o.push(191),o.push(127),o.push(223),o.push(239),o.push(255),o.push(70),o.push(35),o.push(39),o.push(71),o.push(103),o.push(140),o.push(25),o.push(29),o.push(141),o.push(157),o.push(142),o.push(78),o.push(206),o.push(27),o.push(43),o.push(59),o}const Y=X();class B{constructor(t){g(this,"config");this.config=t}generate(){const{tileFormat:t,tileSize:i,padding:e,offset:s}=this.config,n=t===16?F:Y,r=t===16?4:8,c=t===16?4:6,a=s+r*(i+e),l=s+c*(i+e),d=new C(a,l);for(let h=0;h<n.length;h++){const x=h%r,v=Math.floor(h/r),u=s+x*(i+e),p=s+v*(i+e);this.drawTile(d,u,p,n[h])}return d}drawTile(t,i,e,s){const{tileSize:n,fillColor:r,borderColor:c,borderWidth:a}=this.config,l=t.getContext();t.fillRect({x:i,y:e,width:n,height:n},r),l.fillStyle=`rgba(${c.r}, ${c.g}, ${c.b}, ${c.a/255})`,s&1||l.fillRect(i,e,n,a),s&2||l.fillRect(i+n-a,e,a,n),s&4||l.fillRect(i,e+n-a,n,a),s&8||l.fillRect(i,e,a,n),this.config.tileFormat===47&&(s&1&&s&8&&!(s&16)&&l.fillRect(i,e,a,a),s&1&&s&2&&!(s&32)&&l.fillRect(i+n-a,e,a,a),s&4&&s&2&&!(s&64)&&l.fillRect(i+n-a,e+n-a,a,a),s&4&&s&8&&!(s&128)&&l.fillRect(i,e+n-a,a,a))}static drawGrid(t,i){const{tileFormat:e,tileSize:s,padding:n,offset:r}=i,c=e===16?4:8,a=e===16?4:6,l={r:128,g:128,b:128,a:180};for(let d=0;d<=c;d++){const h=r+d*(s+n)-(n>0?n/2:0);t.drawLine(h,0,h,t.getHeight(),l,1)}for(let d=0;d<=a;d++){const h=r+d*(s+n)-(n>0?n/2:0);t.drawLine(0,h,t.getWidth(),h,l,1)}}static getDimensions(t){const{tileFormat:i,tileSize:e,padding:s,offset:n}=t,r=i===16?4:8,c=i===16?4:6,a=n+r*(e+s),l=n+c*(e+s);return{width:a,height:l,cols:r,rows:c}}}class O{constructor(t){g(this,"config");this.config=t}adjust(t){const{tileFormat:i,tileSize:e,padding:s,offset:n}=this.config,r=B.getDimensions(this.config),c=new C(r.width,r.height),a=[],l=i===16?16:47,d=r.cols;for(let h=0;h<l;h++){const x=h%d,v=Math.floor(h/d),u=n+x*(e+s),p=n+v*(e+s),y={x:u,y:p,width:e,height:e},w=this.estimateSourceTileRect(t,h,d,l),I=t.detectContentBounds(w);let S;if(I){const f={x:w.x+I.minX,y:w.y+I.minY,width:I.maxX-I.minX+1,height:I.maxY-I.minY+1},j=e/f.width,T=e/f.height,m=Math.min(j,T),b=f.width*m,R=f.height*m,P=(e-b)/2,D=(e-R)/2;c.drawImage(t.getCanvas(),f.x,f.y,f.width,f.height,u+P,p+D,b,R),S={index:h,original:w,detected:f,adjusted:{x:u+P,y:p+D,width:b,height:R},scale:{x:m,y:m},offset:{x:P,y:D}}}else c.drawImage(t.getCanvas(),w.x,w.y,w.width,w.height,u,p,e,e),S={index:h,original:w,detected:null,adjusted:y,scale:{x:1,y:1},offset:{x:0,y:0}};a.push(S)}return{processor:c,adjustments:a}}estimateSourceTileRect(t,i,e,s){const{tileSize:n,padding:r,offset:c}=this.config,a=i%e,l=Math.floor(i/e),d=t.getWidth(),h=t.getHeight(),x=c+e*(n+r),v=Math.ceil(s/e),u=c+v*(n+r),p=d/x,y=h/u,w=Math.round((c+a*(n+r))*p),I=Math.round((c+l*(n+r))*y),S=Math.round(n*p),f=Math.round(n*y);return{x:Math.max(0,Math.min(w,d-S)),y:Math.max(0,Math.min(I,h-f)),width:Math.min(S,d-w),height:Math.min(f,h-I)}}adjustWithContentDetection(t){const{tileFormat:i,tileSize:e,padding:s,offset:n}=this.config,r=B.getDimensions(this.config),c=new C(r.width,r.height),a=[],l=i===16?16:47,d=r.cols,h=[];for(let u=0;u<l;u++){const p=this.estimateSourceTileRect(t,u,d,l),y=t.detectContentBounds(p);y&&h.push({width:y.maxX-y.minX+1,height:y.maxY-y.minY+1})}let x=e,v=e;h.length>0&&(x=h.reduce((u,p)=>u+p.width,0)/h.length,v=h.reduce((u,p)=>u+p.height,0)/h.length);for(let u=0;u<l;u++){const p=u%d,y=Math.floor(u/d),w=n+p*(e+s),I=n+y*(e+s),S={x:w,y:I,width:e,height:e},f=this.estimateSourceTileRect(t,u,d,l),j=t.detectContentBounds(f);let T;if(j){const m={x:f.x+j.minX,y:f.y+j.minY,width:j.maxX-j.minX+1,height:j.maxY-j.minY+1},b=Math.min(e/x,e/v),R=m.width*b,P=m.height*b,D=Math.min(R,e),A=Math.min(P,e),E=Math.min(D/m.width,A/m.height),L=(e-m.width*E)/2,M=(e-m.height*E)/2;c.drawImage(t.getCanvas(),m.x,m.y,m.width,m.height,w+L,I+M,m.width*E,m.height*E),T={index:u,original:f,detected:m,adjusted:{x:w+L,y:I+M,width:m.width*E,height:m.height*E},scale:{x:E,y:E},offset:{x:L,y:M}}}else c.drawImage(t.getCanvas(),f.x,f.y,f.width,f.height,w,I,e,e),T={index:u,original:f,detected:null,adjusted:S,scale:{x:1,y:1},offset:{x:0,y:0}};a.push(T)}return{processor:c,adjustments:a}}}class ${constructor(){g(this,"tileFormatSelect");g(this,"tileSizeInput");g(this,"tilePaddingInput");g(this,"tileOffsetInput");g(this,"fillColorInput");g(this,"borderColorInput");g(this,"borderWidthInput");g(this,"generateBtn");g(this,"saveTemplateBtn");g(this,"spriteInput");g(this,"autoAdjustBtn");g(this,"saveAdjustedBtn");g(this,"templateCanvas");g(this,"originalCanvas");g(this,"adjustedCanvas");g(this,"templateProcessor",null);g(this,"originalProcessor",null);g(this,"adjustedProcessor",null);this.initElements(),this.bindEvents(),this.generateTemplate()}initElements(){this.tileFormatSelect=document.getElementById("tileFormat"),this.tileSizeInput=document.getElementById("tileSize"),this.tilePaddingInput=document.getElementById("tilePadding"),this.tileOffsetInput=document.getElementById("tileOffset"),this.fillColorInput=document.getElementById("fillColor"),this.borderColorInput=document.getElementById("borderColor"),this.borderWidthInput=document.getElementById("borderWidth"),this.generateBtn=document.getElementById("generateBtn"),this.saveTemplateBtn=document.getElementById("saveTemplateBtn"),this.spriteInput=document.getElementById("spriteInput"),this.autoAdjustBtn=document.getElementById("autoAdjustBtn"),this.saveAdjustedBtn=document.getElementById("saveAdjustedBtn"),this.templateCanvas=document.getElementById("templateCanvas"),this.originalCanvas=document.getElementById("originalCanvas"),this.adjustedCanvas=document.getElementById("adjustedCanvas")}bindEvents(){this.generateBtn.addEventListener("click",()=>this.generateTemplate()),this.saveTemplateBtn.addEventListener("click",()=>this.saveTemplate()),this.spriteInput.addEventListener("change",i=>this.loadSprite(i)),this.autoAdjustBtn.addEventListener("click",()=>this.autoAdjust()),this.saveAdjustedBtn.addEventListener("click",()=>this.saveAdjusted()),[this.tileFormatSelect,this.tileSizeInput,this.tilePaddingInput,this.tileOffsetInput,this.fillColorInput,this.borderColorInput,this.borderWidthInput].forEach(i=>{i.addEventListener("change",()=>this.generateTemplate())})}getConfig(){const t=parseInt(this.tileSizeInput.value)||64,i=parseInt(this.borderWidthInput.value)||10;return{tileFormat:parseInt(this.tileFormatSelect.value),tileSize:t,padding:parseInt(this.tilePaddingInput.value)||0,offset:parseInt(this.tileOffsetInput.value)||0,fillColor:C.hexToColor(this.fillColorInput.value),borderColor:C.hexToColor(this.borderColorInput.value),borderWidth:Math.min(i,Math.floor(t/2))}}generateTemplate(){const t=this.getConfig(),i=new B(t);this.templateProcessor=i.generate();const e=this.templateProcessor.clone();B.drawGrid(e,t),this.renderToCanvas(e,this.templateCanvas)}saveTemplate(){if(!this.templateProcessor){alert("テンプレートを生成してください");return}const i=`sprite_template_${this.tileFormatSelect.value}tiles.png`;this.templateProcessor.downloadAsFile(i)}async loadSprite(t){var s;const e=(s=t.target.files)==null?void 0:s[0];if(e)try{const n=URL.createObjectURL(e),r=await C.loadImage(n);this.originalProcessor=await C.fromImage(r),URL.revokeObjectURL(n);const c=this.getConfig(),a=this.originalProcessor.clone();B.drawGrid(a,c),this.renderToCanvas(a,this.originalCanvas),this.adjustedProcessor=null,this.clearCanvas(this.adjustedCanvas)}catch(n){console.error("Failed to load image:",n),alert("画像の読み込みに失敗しました")}}autoAdjust(){if(!this.originalProcessor){alert("スプライトシート画像を読み込んでください");return}const t=this.getConfig(),e=new O(t).adjustWithContentDetection(this.originalProcessor);this.adjustedProcessor=e.processor;const s=this.adjustedProcessor.clone();B.drawGrid(s,t),this.renderToCanvas(s,this.adjustedCanvas),console.log("Adjustments:",e.adjustments)}saveAdjusted(){if(!this.adjustedProcessor){alert("自動調整を実行してください");return}const i=`sprite_adjusted_${this.tileFormatSelect.value}tiles.png`;this.adjustedProcessor.downloadAsFile(i)}renderToCanvas(t,i){i.width=t.getWidth(),i.height=t.getHeight();const e=i.getContext("2d");e&&e.drawImage(t.getCanvas(),0,0)}clearCanvas(t){const i=t.getContext("2d");i&&i.clearRect(0,0,t.width,t.height)}}document.addEventListener("DOMContentLoaded",()=>{new $});
