var W=Object.defineProperty;var z=(r,t,o)=>t in r?W(r,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):r[t]=o;var h=(r,t,o)=>z(r,typeof t!="symbol"?t+"":t,o);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))e(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const l of s.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&e(l)}).observe(document,{childList:!0,subtree:!0});function o(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function e(i){if(i.ep)return;i.ep=!0;const s=o(i);fetch(i.href,s)}})();class C{constructor(t,o){h(this,"canvas");h(this,"ctx");this.canvas=document.createElement("canvas"),this.canvas.width=t,this.canvas.height=o;const e=this.canvas.getContext("2d");if(!e)throw new Error("Failed to get 2D context");this.ctx=e}static fromCanvas(t){const o=new C(t.width,t.height);o.canvas=t;const e=t.getContext("2d");if(!e)throw new Error("Failed to get 2D context");return o.ctx=e,o}static async fromImage(t){const o=new C(t.width,t.height);return o.ctx.drawImage(t,0,0),o}static async loadImage(t){return new Promise((o,e)=>{const i=new Image;i.onload=()=>o(i),i.onerror=e,i.src=t})}getCanvas(){return this.canvas}getContext(){return this.ctx}getWidth(){return this.canvas.width}getHeight(){return this.canvas.height}clear(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}fill(t){this.ctx.fillStyle=this.colorToString(t),this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)}fillRect(t,o){this.ctx.fillStyle=this.colorToString(o),this.ctx.fillRect(t.x,t.y,t.width,t.height)}strokeRect(t,o,e){this.ctx.strokeStyle=this.colorToString(o),this.ctx.lineWidth=e,this.ctx.strokeRect(t.x+e/2,t.y+e/2,t.width-e,t.height-e)}drawLine(t,o,e,i,s,l){this.ctx.strokeStyle=this.colorToString(s),this.ctx.lineWidth=l,this.ctx.beginPath(),this.ctx.moveTo(t,o),this.ctx.lineTo(e,i),this.ctx.stroke()}drawImage(t,o,e,i,s,l,n,a,g){const c=t instanceof C?t.getCanvas():t;this.ctx.drawImage(c,o,e,i,s,l,n,a,g)}getImageData(t){return t?this.ctx.getImageData(t.x,t.y,t.width,t.height):this.ctx.getImageData(0,0,this.canvas.width,this.canvas.height)}putImageData(t,o,e){this.ctx.putImageData(t,o,e)}getPixel(t,o){const e=this.ctx.getImageData(t,o,1,1).data;return{r:e[0],g:e[1],b:e[2],a:e[3]}}setPixel(t,o,e){const i=this.ctx.createImageData(1,1);i.data[0]=e.r,i.data[1]=e.g,i.data[2]=e.b,i.data[3]=e.a,this.ctx.putImageData(i,t,o)}detectContentBounds(t,o=10){const i=this.getImageData(t).data,s=t.width,l=t.height;let n=s,a=l,g=0,c=0,d=!1;for(let w=0;w<l;w++)for(let x=0;x<s;x++){const u=(w*s+x)*4;i[u+3]>o&&(d=!0,x<n&&(n=x),w<a&&(a=w),x>g&&(g=x),w>c&&(c=w))}return d?{minX:n,minY:a,maxX:g,maxY:c}:null}drawResized(t,o,e){this.ctx.drawImage(t.getCanvas(),o.x,o.y,o.width,o.height,e.x,e.y,e.width,e.height)}toDataURL(t="image/png"){return this.canvas.toDataURL(t)}toBlob(t="image/png"){return new Promise((o,e)=>{this.canvas.toBlob(i=>{i?o(i):e(new Error("Failed to create blob"))},t)})}downloadAsFile(t){const o=document.createElement("a");o.download=t,o.href=this.toDataURL(),o.click()}clone(){const t=new C(this.canvas.width,this.canvas.height);return t.ctx.drawImage(this.canvas,0,0),t}resize(t,o){const e=new C(t,o);return e.ctx.drawImage(this.canvas,0,0,t,o),e}colorToString(t){return`rgba(${t.r}, ${t.g}, ${t.b}, ${t.a/255})`}static hexToColor(t){const o=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return o?{r:parseInt(o[1],16),g:parseInt(o[2],16),b:parseInt(o[3],16),a:255}:{r:0,g:0,b:0,a:255}}static colorToHex(t){const o=e=>e.toString(16).padStart(2,"0");return`#${o(t.r)}${o(t.g)}${o(t.b)}`}}const F=[0,2,10,8,4,6,14,12,5,7,15,13,1,3,11,9];function X(){const r=[];for(let t=0;t<16;t++)r.push(F[t]);return r.push(79),r.push(143),r.push(47),r.push(31),r.push(63),r.push(207),r.push(159),r.push(111),r.push(95),r.push(175),r.push(191),r.push(127),r.push(223),r.push(239),r.push(255),r.push(70),r.push(35),r.push(39),r.push(71),r.push(103),r.push(140),r.push(25),r.push(29),r.push(141),r.push(157),r.push(142),r.push(78),r.push(206),r.push(27),r.push(43),r.push(59),r}const Y=X();class E{constructor(t){h(this,"config");this.config=t}generate(){const{tileFormat:t,tileSize:o,padding:e,offset:i}=this.config,s=t===16?F:Y,l=t===16?4:8,n=t===16?4:6,a=i+l*(o+e),g=i+n*(o+e),c=new C(a,g);for(let d=0;d<s.length;d++){const w=d%l,x=Math.floor(d/l),u=i+w*(o+e),p=i+x*(o+e);this.drawTile(c,u,p,s[d])}return c}colorToStyle(t){return`rgba(${t.r}, ${t.g}, ${t.b}, ${t.a/255})`}getBorderColor(t){const{detailedColorMode:o,detailedColors:e,borderColor:i}=this.config;return o&&e?e[t]:i}drawTile(t,o,e,i){const{tileSize:s,fillColor:l,borderWidth:n}=this.config,a=t.getContext();t.fillRect({x:o,y:e,width:s,height:s},l),i&1||(a.fillStyle=this.colorToStyle(this.getBorderColor("top")),a.fillRect(o,e,s,n)),i&2||(a.fillStyle=this.colorToStyle(this.getBorderColor("right")),a.fillRect(o+s-n,e,n,s)),i&4||(a.fillStyle=this.colorToStyle(this.getBorderColor("bottom")),a.fillRect(o,e+s-n,s,n)),i&8||(a.fillStyle=this.colorToStyle(this.getBorderColor("left")),a.fillRect(o,e,n,s));const g=this.getBorderColor("corner");a.fillStyle=this.colorToStyle(g),!(i&1)&&!(i&8)&&a.fillRect(o,e,n,n),!(i&1)&&!(i&2)&&a.fillRect(o+s-n,e,n,n),!(i&4)&&!(i&2)&&a.fillRect(o+s-n,e+s-n,n,n),!(i&4)&&!(i&8)&&a.fillRect(o,e+s-n,n,n),this.config.tileFormat===47&&(i&1&&i&8&&!(i&16)&&a.fillRect(o,e,n,n),i&1&&i&2&&!(i&32)&&a.fillRect(o+s-n,e,n,n),i&4&&i&2&&!(i&64)&&a.fillRect(o+s-n,e+s-n,n,n),i&4&&i&8&&!(i&128)&&a.fillRect(o,e+s-n,n,n))}static drawGrid(t,o){const{tileFormat:e,tileSize:i,padding:s,offset:l}=o,n=e===16?4:8,a=e===16?4:6,g={r:128,g:128,b:128,a:180};for(let c=0;c<=n;c++){const d=l+c*(i+s)-(s>0?s/2:0);t.drawLine(d,0,d,t.getHeight(),g,1)}for(let c=0;c<=a;c++){const d=l+c*(i+s)-(s>0?s/2:0);t.drawLine(0,d,t.getWidth(),d,g,1)}}static getDimensions(t){const{tileFormat:o,tileSize:e,padding:i,offset:s}=t,l=o===16?4:8,n=o===16?4:6,a=s+l*(e+i),g=s+n*(e+i);return{width:a,height:g,cols:l,rows:n}}}class O{constructor(t){h(this,"config");this.config=t}adjust(t){const{tileFormat:o,tileSize:e,padding:i,offset:s}=this.config,l=E.getDimensions(this.config),n=new C(l.width,l.height),a=[],g=o===16?16:47,c=l.cols;for(let d=0;d<g;d++){const w=d%c,x=Math.floor(d/c),u=s+w*(e+i),p=s+x*(e+i),b={x:u,y:p,width:e,height:e},I=this.estimateSourceTileRect(t,d,c,g),v=t.detectContentBounds(I);let S;if(v){const f={x:I.x+v.minX,y:I.y+v.minY,width:v.maxX-v.minX+1,height:v.maxY-v.minY+1},y=e/f.width,j=e/f.height,m=Math.min(y,j),B=f.width*m,R=f.height*m,L=(e-B)/2,M=(e-R)/2;n.drawImage(t.getCanvas(),f.x,f.y,f.width,f.height,u+L,p+M,B,R),S={index:d,original:I,detected:f,adjusted:{x:u+L,y:p+M,width:B,height:R},scale:{x:m,y:m},offset:{x:L,y:M}}}else n.drawImage(t.getCanvas(),I.x,I.y,I.width,I.height,u,p,e,e),S={index:d,original:I,detected:null,adjusted:b,scale:{x:1,y:1},offset:{x:0,y:0}};a.push(S)}return{processor:n,adjustments:a}}estimateSourceTileRect(t,o,e,i){const{tileSize:s,padding:l,offset:n}=this.config,a=o%e,g=Math.floor(o/e),c=t.getWidth(),d=t.getHeight(),w=n+e*(s+l),x=Math.ceil(i/e),u=n+x*(s+l),p=c/w,b=d/u,I=Math.round((n+a*(s+l))*p),v=Math.round((n+g*(s+l))*b),S=Math.round(s*p),f=Math.round(s*b);return{x:Math.max(0,Math.min(I,c-S)),y:Math.max(0,Math.min(v,d-f)),width:Math.min(S,c-I),height:Math.min(f,d-v)}}adjustWithContentDetection(t){const{tileFormat:o,tileSize:e,padding:i,offset:s}=this.config,l=E.getDimensions(this.config),n=new C(l.width,l.height),a=[],g=o===16?16:47,c=l.cols,d=[];for(let u=0;u<g;u++){const p=this.estimateSourceTileRect(t,u,c,g),b=t.detectContentBounds(p);b&&d.push({width:b.maxX-b.minX+1,height:b.maxY-b.minY+1})}let w=e,x=e;d.length>0&&(w=d.reduce((u,p)=>u+p.width,0)/d.length,x=d.reduce((u,p)=>u+p.height,0)/d.length);for(let u=0;u<g;u++){const p=u%c,b=Math.floor(u/c),I=s+p*(e+i),v=s+b*(e+i),S={x:I,y:v,width:e,height:e},f=this.estimateSourceTileRect(t,u,c,g),y=t.detectContentBounds(f);let j;if(y){const m={x:f.x+y.minX,y:f.y+y.minY,width:y.maxX-y.minX+1,height:y.maxY-y.minY+1},B=Math.min(e/w,e/x),R=m.width*B,L=m.height*B,M=Math.min(R,e),A=Math.min(L,e),T=Math.min(M/m.width,A/m.height),P=(e-m.width*T)/2,D=(e-m.height*T)/2;n.drawImage(t.getCanvas(),m.x,m.y,m.width,m.height,I+P,v+D,m.width*T,m.height*T),j={index:u,original:f,detected:m,adjusted:{x:I+P,y:v+D,width:m.width*T,height:m.height*T},scale:{x:T,y:T},offset:{x:P,y:D}}}else n.drawImage(t.getCanvas(),f.x,f.y,f.width,f.height,I,v,e,e),j={index:u,original:f,detected:null,adjusted:S,scale:{x:1,y:1},offset:{x:0,y:0}};a.push(j)}return{processor:n,adjustments:a}}}class ${constructor(){h(this,"tileFormatSelect");h(this,"tileSizeInput");h(this,"tilePaddingInput");h(this,"tileOffsetInput");h(this,"fillColorInput");h(this,"borderColorInput");h(this,"borderWidthInput");h(this,"detailedColorModeCheckbox");h(this,"detailedColorSettings");h(this,"borderColorGroup");h(this,"borderColorTopInput");h(this,"borderColorBottomInput");h(this,"borderColorLeftInput");h(this,"borderColorRightInput");h(this,"borderColorCornerInput");h(this,"saveTemplateBtn");h(this,"spriteInput");h(this,"autoAdjustBtn");h(this,"saveAdjustedBtn");h(this,"templateCanvas");h(this,"originalCanvas");h(this,"adjustedCanvas");h(this,"templateProcessor",null);h(this,"originalProcessor",null);h(this,"adjustedProcessor",null);this.initElements(),this.bindEvents(),this.generateTemplate()}initElements(){this.tileFormatSelect=document.getElementById("tileFormat"),this.tileSizeInput=document.getElementById("tileSize"),this.tilePaddingInput=document.getElementById("tilePadding"),this.tileOffsetInput=document.getElementById("tileOffset"),this.fillColorInput=document.getElementById("fillColor"),this.borderColorInput=document.getElementById("borderColor"),this.borderWidthInput=document.getElementById("borderWidth"),this.detailedColorModeCheckbox=document.getElementById("detailedColorMode"),this.detailedColorSettings=document.getElementById("detailedColorSettings"),this.borderColorGroup=document.getElementById("borderColorGroup"),this.borderColorTopInput=document.getElementById("borderColorTop"),this.borderColorBottomInput=document.getElementById("borderColorBottom"),this.borderColorLeftInput=document.getElementById("borderColorLeft"),this.borderColorRightInput=document.getElementById("borderColorRight"),this.borderColorCornerInput=document.getElementById("borderColorCorner"),this.saveTemplateBtn=document.getElementById("saveTemplateBtn"),this.spriteInput=document.getElementById("spriteInput"),this.autoAdjustBtn=document.getElementById("autoAdjustBtn"),this.saveAdjustedBtn=document.getElementById("saveAdjustedBtn"),this.templateCanvas=document.getElementById("templateCanvas"),this.originalCanvas=document.getElementById("originalCanvas"),this.adjustedCanvas=document.getElementById("adjustedCanvas")}bindEvents(){this.saveTemplateBtn.addEventListener("click",()=>this.saveTemplate()),this.spriteInput.addEventListener("change",o=>this.loadSprite(o)),this.autoAdjustBtn.addEventListener("click",()=>this.autoAdjust()),this.saveAdjustedBtn.addEventListener("click",()=>this.saveAdjusted()),this.detailedColorModeCheckbox.addEventListener("change",()=>{this.toggleDetailedColorSettings(),this.generateTemplate()}),[this.tileFormatSelect,this.tileSizeInput,this.tilePaddingInput,this.tileOffsetInput,this.fillColorInput,this.borderColorInput,this.borderWidthInput,this.borderColorTopInput,this.borderColorBottomInput,this.borderColorLeftInput,this.borderColorRightInput,this.borderColorCornerInput].forEach(o=>{o.addEventListener("change",()=>this.generateTemplate())})}toggleDetailedColorSettings(){this.detailedColorModeCheckbox.checked?(this.detailedColorSettings.classList.remove("hidden"),this.borderColorGroup.classList.add("hidden")):(this.detailedColorSettings.classList.add("hidden"),this.borderColorGroup.classList.remove("hidden"))}getConfig(){const t=parseInt(this.tileSizeInput.value)||64,o=parseInt(this.borderWidthInput.value)||10,e=this.detailedColorModeCheckbox.checked,i={tileFormat:parseInt(this.tileFormatSelect.value),tileSize:t,padding:parseInt(this.tilePaddingInput.value)||0,offset:parseInt(this.tileOffsetInput.value)||0,fillColor:C.hexToColor(this.fillColorInput.value),borderColor:C.hexToColor(this.borderColorInput.value),borderWidth:Math.min(o,Math.floor(t/2)),detailedColorMode:e};return e&&(i.detailedColors={top:C.hexToColor(this.borderColorTopInput.value),bottom:C.hexToColor(this.borderColorBottomInput.value),left:C.hexToColor(this.borderColorLeftInput.value),right:C.hexToColor(this.borderColorRightInput.value),corner:C.hexToColor(this.borderColorCornerInput.value)}),i}generateTemplate(){const t=this.getConfig(),o=new E(t);this.templateProcessor=o.generate();const e=this.templateProcessor.clone();E.drawGrid(e,t),this.renderToCanvas(e,this.templateCanvas)}saveTemplate(){if(!this.templateProcessor){alert("テンプレートを生成してください");return}const o=`sprite_template_${this.tileFormatSelect.value}tiles.png`;this.templateProcessor.downloadAsFile(o)}async loadSprite(t){var i;const e=(i=t.target.files)==null?void 0:i[0];if(e)try{const s=URL.createObjectURL(e),l=await C.loadImage(s);this.originalProcessor=await C.fromImage(l),URL.revokeObjectURL(s);const n=this.getConfig(),a=this.originalProcessor.clone();E.drawGrid(a,n),this.renderToCanvas(a,this.originalCanvas),this.adjustedProcessor=null,this.clearCanvas(this.adjustedCanvas)}catch(s){console.error("Failed to load image:",s),alert("画像の読み込みに失敗しました")}}autoAdjust(){if(!this.originalProcessor){alert("スプライトシート画像を読み込んでください");return}const t=this.getConfig(),e=new O(t).adjustWithContentDetection(this.originalProcessor);this.adjustedProcessor=e.processor;const i=this.adjustedProcessor.clone();E.drawGrid(i,t),this.renderToCanvas(i,this.adjustedCanvas),console.log("Adjustments:",e.adjustments)}saveAdjusted(){if(!this.adjustedProcessor){alert("自動調整を実行してください");return}const o=`sprite_adjusted_${this.tileFormatSelect.value}tiles.png`;this.adjustedProcessor.downloadAsFile(o)}renderToCanvas(t,o){o.width=t.getWidth(),o.height=t.getHeight();const e=o.getContext("2d");e&&e.drawImage(t.getCanvas(),0,0)}clearCanvas(t){const o=t.getContext("2d");o&&o.clearRect(0,0,t.width,t.height)}}document.addEventListener("DOMContentLoaded",()=>{new $});
