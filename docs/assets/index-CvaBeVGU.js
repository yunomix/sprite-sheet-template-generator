var k=Object.defineProperty;var A=(r,t,o)=>t in r?k(r,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):r[t]=o;var u=(r,t,o)=>A(r,typeof t!="symbol"?t+"":t,o);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))e(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const a of s.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&e(a)}).observe(document,{childList:!0,subtree:!0});function o(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function e(i){if(i.ep)return;i.ep=!0;const s=o(i);fetch(i.href,s)}})();class I{constructor(t,o){u(this,"canvas");u(this,"ctx");this.canvas=document.createElement("canvas"),this.canvas.width=t,this.canvas.height=o;const e=this.canvas.getContext("2d");if(!e)throw new Error("Failed to get 2D context");this.ctx=e}static fromCanvas(t){const o=new I(t.width,t.height);o.canvas=t;const e=t.getContext("2d");if(!e)throw new Error("Failed to get 2D context");return o.ctx=e,o}static async fromImage(t){const o=new I(t.width,t.height);return o.ctx.drawImage(t,0,0),o}static async loadImage(t){return new Promise((o,e)=>{const i=new Image;i.onload=()=>o(i),i.onerror=e,i.src=t})}getCanvas(){return this.canvas}getContext(){return this.ctx}getWidth(){return this.canvas.width}getHeight(){return this.canvas.height}clear(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}fill(t){this.ctx.fillStyle=this.colorToString(t),this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)}fillRect(t,o){this.ctx.fillStyle=this.colorToString(o),this.ctx.fillRect(t.x,t.y,t.width,t.height)}strokeRect(t,o,e){this.ctx.strokeStyle=this.colorToString(o),this.ctx.lineWidth=e,this.ctx.strokeRect(t.x+e/2,t.y+e/2,t.width-e,t.height-e)}drawLine(t,o,e,i,s,a){this.ctx.strokeStyle=this.colorToString(s),this.ctx.lineWidth=a,this.ctx.beginPath(),this.ctx.moveTo(t,o),this.ctx.lineTo(e,i),this.ctx.stroke()}drawImage(t,o,e,i,s,a,n,l,c){const g=t instanceof I?t.getCanvas():t;this.ctx.drawImage(g,o,e,i,s,a,n,l,c)}getImageData(t){return t?this.ctx.getImageData(t.x,t.y,t.width,t.height):this.ctx.getImageData(0,0,this.canvas.width,this.canvas.height)}putImageData(t,o,e){this.ctx.putImageData(t,o,e)}getPixel(t,o){const e=this.ctx.getImageData(t,o,1,1).data;return{r:e[0],g:e[1],b:e[2],a:e[3]}}setPixel(t,o,e){const i=this.ctx.createImageData(1,1);i.data[0]=e.r,i.data[1]=e.g,i.data[2]=e.b,i.data[3]=e.a,this.ctx.putImageData(i,t,o)}detectContentBounds(t,o=10){const i=this.getImageData(t).data,s=t.width,a=t.height;let n=s,l=a,c=0,g=0,h=!1;for(let d=0;d<a;d++)for(let f=0;f<s;f++){const m=(d*s+f)*4;i[m+3]>o&&(h=!0,f<n&&(n=f),d<l&&(l=d),f>c&&(c=f),d>g&&(g=d))}return h?{minX:n,minY:l,maxX:c,maxY:g}:null}drawResized(t,o,e){this.ctx.drawImage(t.getCanvas(),o.x,o.y,o.width,o.height,e.x,e.y,e.width,e.height)}toDataURL(t="image/png"){return this.canvas.toDataURL(t)}toBlob(t="image/png"){return new Promise((o,e)=>{this.canvas.toBlob(i=>{i?o(i):e(new Error("Failed to create blob"))},t)})}downloadAsFile(t){const o=document.createElement("a");o.download=t,o.href=this.toDataURL(),o.click()}clone(){const t=new I(this.canvas.width,this.canvas.height);return t.ctx.drawImage(this.canvas,0,0),t}resize(t,o){const e=new I(t,o);return e.ctx.drawImage(this.canvas,0,0,t,o),e}colorToString(t){return`rgba(${t.r}, ${t.g}, ${t.b}, ${t.a/255})`}static hexToColor(t){const o=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return o?{r:parseInt(o[1],16),g:parseInt(o[2],16),b:parseInt(o[3],16),a:255}:{r:0,g:0,b:0,a:255}}static colorToHex(t){const o=e=>e.toString(16).padStart(2,"0");return`#${o(t.r)}${o(t.g)}${o(t.b)}`}}const W=[0,2,10,8,4,6,14,12,5,7,15,13,1,3,11,9];function z(){const r=[];for(let t=0;t<16;t++)r.push(W[t]);return r.push(79),r.push(143),r.push(47),r.push(31),r.push(63),r.push(207),r.push(159),r.push(111),r.push(95),r.push(175),r.push(191),r.push(127),r.push(223),r.push(239),r.push(255),r.push(70),r.push(35),r.push(39),r.push(71),r.push(103),r.push(140),r.push(25),r.push(29),r.push(141),r.push(157),r.push(142),r.push(78),r.push(206),r.push(27),r.push(43),r.push(59),r}const O=z();class M{constructor(t){u(this,"config");this.config=t}generate(){const{tileFormat:t,tileSize:o,padding:e,offset:i}=this.config,s=t===16?W:O,a=t===16?4:8,n=t===16?4:6,l=i+a*(o+e),c=i+n*(o+e),g=new I(l,c);for(let h=0;h<s.length;h++){const d=h%a,f=Math.floor(h/a),m=i+d*(o+e),w=i+f*(o+e);this.drawTile(g,m,w,s[h])}return g}colorToStyle(t){return`rgba(${t.r}, ${t.g}, ${t.b}, ${t.a/255})`}getBorderColor(t){const{detailedColorMode:o,detailedColors:e,borderColor:i}=this.config;return o&&e?e[t]:i}drawTile(t,o,e,i){const{tileSize:s,fillColor:a,borderWidth:n}=this.config,l=t.getContext();t.fillRect({x:o,y:e,width:s,height:s},a),i&1||(l.fillStyle=this.colorToStyle(this.getBorderColor("top")),l.fillRect(o,e,s,n)),i&2||(l.fillStyle=this.colorToStyle(this.getBorderColor("right")),l.fillRect(o+s-n,e,n,s)),i&4||(l.fillStyle=this.colorToStyle(this.getBorderColor("bottom")),l.fillRect(o,e+s-n,s,n)),i&8||(l.fillStyle=this.colorToStyle(this.getBorderColor("left")),l.fillRect(o,e,n,s));const c=this.getBorderColor("corner");l.fillStyle=this.colorToStyle(c),!(i&1)&&!(i&8)&&l.fillRect(o,e,n,n),!(i&1)&&!(i&2)&&l.fillRect(o+s-n,e,n,n),!(i&4)&&!(i&2)&&l.fillRect(o+s-n,e+s-n,n,n),!(i&4)&&!(i&8)&&l.fillRect(o,e+s-n,n,n),this.config.tileFormat===47&&(i&1&&i&8&&!(i&16)&&l.fillRect(o,e,n,n),i&1&&i&2&&!(i&32)&&l.fillRect(o+s-n,e,n,n),i&4&&i&2&&!(i&64)&&l.fillRect(o+s-n,e+s-n,n,n),i&4&&i&8&&!(i&128)&&l.fillRect(o,e+s-n,n,n))}static drawGrid(t,o){const{tileFormat:e,tileSize:i,padding:s,offset:a}=o,n=e===16?4:8,l=e===16?4:6,c={r:128,g:128,b:128,a:180},g=t.getWidth(),h=t.getHeight();for(let d=0;d<=n;d++){const f=a+d*(i+s);f>=0&&f<=g&&t.drawLine(f,0,f,h,c,1)}for(let d=0;d<=l;d++){const f=a+d*(i+s);f>=0&&f<=h&&t.drawLine(0,f,g,f,c,1)}}static getDimensions(t){const{tileFormat:o,tileSize:e,padding:i,offset:s}=t,a=o===16?4:8,n=o===16?4:6,l=s+a*(e+i),c=s+n*(e+i);return{width:l,height:c,cols:a,rows:n}}}class X{constructor(t){u(this,"config");this.config=t}adjust(t){const{tileFormat:o,tileSize:e,padding:i,offset:s}=this.config,a=M.getDimensions(this.config),n=new I(a.width,a.height),l=[],c=o===16?16:47,g=a.cols;for(let h=0;h<c;h++){const d=h%g,f=Math.floor(h/g),m=s+d*(e+i),w=s+f*(e+i),b={x:m,y:w,width:e,height:e},v=this.estimateSourceTileRect(t,h,g,c),x=t.detectContentBounds(v);let S;if(x){const p={x:v.x+x.minX,y:v.y+x.minY,width:x.maxX-x.minX+1,height:x.maxY-x.minY+1},y=e/p.width,E=e/p.height,C=Math.min(y,E),T=p.width*C,j=p.height*C,R=(e-T)/2,L=(e-j)/2;n.drawImage(t.getCanvas(),p.x,p.y,p.width,p.height,m+R,w+L,T,j),S={index:h,original:v,detected:p,adjusted:{x:m+R,y:w+L,width:T,height:j},scale:{x:C,y:C},offset:{x:R,y:L}}}else n.drawImage(t.getCanvas(),v.x,v.y,v.width,v.height,m,w,e,e),S={index:h,original:v,detected:null,adjusted:b,scale:{x:1,y:1},offset:{x:0,y:0}};l.push(S)}return{processor:n,adjustments:l}}estimateSourceTileRect(t,o,e,i){const{tileSize:s,padding:a,offset:n}=this.config,l=o%e,c=Math.floor(o/e),g=t.getWidth(),h=t.getHeight(),d=n+e*(s+a),f=Math.ceil(i/e),m=n+f*(s+a),w=g/d,b=h/m,v=Math.round((n+l*(s+a))*w),x=Math.round((n+c*(s+a))*b),S=Math.round(s*w),p=Math.round(s*b);return{x:Math.max(0,Math.min(v,g-S)),y:Math.max(0,Math.min(x,h-p)),width:Math.min(S,g-v),height:Math.min(p,h-x)}}adjustWithContentDetection(t){const{tileFormat:o,tileSize:e,padding:i,offset:s}=this.config,a=M.getDimensions(this.config),n=new I(a.width,a.height),l=[],c=o===16?16:47,g=a.cols,h=[];for(let m=0;m<c;m++){const w=this.estimateSourceTileRect(t,m,g,c),b=t.detectContentBounds(w);b&&h.push({width:b.maxX-b.minX+1,height:b.maxY-b.minY+1})}let d=e,f=e;h.length>0&&(d=h.reduce((m,w)=>m+w.width,0)/h.length,f=h.reduce((m,w)=>m+w.height,0)/h.length);for(let m=0;m<c;m++){const w=m%g,b=Math.floor(m/g),v=s+w*(e+i),x=s+b*(e+i),S={x:v,y:x,width:e,height:e},p=this.estimateSourceTileRect(t,m,g,c),y=t.detectContentBounds(p);let E;if(y){const C={x:p.x+y.minX,y:p.y+y.minY,width:y.maxX-y.minX+1,height:y.maxY-y.minY+1},T=Math.min(e/d,e/f),j=C.width*T,R=C.height*T,L=Math.min(j,e),F=Math.min(R,e),B=Math.min(L/C.width,F/C.height),P=(e-C.width*B)/2,D=(e-C.height*B)/2;n.drawImage(t.getCanvas(),C.x,C.y,C.width,C.height,v+P,x+D,C.width*B,C.height*B),E={index:m,original:p,detected:C,adjusted:{x:v+P,y:x+D,width:C.width*B,height:C.height*B},scale:{x:B,y:B},offset:{x:P,y:D}}}else n.drawImage(t.getCanvas(),p.x,p.y,p.width,p.height,v,x,e,e),E={index:m,original:p,detected:null,adjusted:S,scale:{x:1,y:1},offset:{x:0,y:0}};l.push(E)}return{processor:n,adjustments:l}}}class Y{constructor(){u(this,"tileFormatSelect");u(this,"tileSizeInput");u(this,"tilePaddingInput");u(this,"tileOffsetInput");u(this,"fillColorInput");u(this,"borderColorInput");u(this,"borderWidthInput");u(this,"detailedColorModeCheckbox");u(this,"detailedColorSettings");u(this,"borderColorGroup");u(this,"borderColorTopInput");u(this,"borderColorBottomInput");u(this,"borderColorLeftInput");u(this,"borderColorRightInput");u(this,"borderColorCornerInput");u(this,"saveTemplateBtn");u(this,"spriteInput");u(this,"autoAdjustBtn");u(this,"saveAdjustedBtn");u(this,"templateCanvas");u(this,"originalCanvas");u(this,"adjustedCanvas");u(this,"templateProcessor",null);u(this,"originalProcessor",null);u(this,"adjustedProcessor",null);this.initElements(),this.bindEvents(),this.generateTemplate()}initElements(){this.tileFormatSelect=document.getElementById("tileFormat"),this.tileSizeInput=document.getElementById("tileSize"),this.tilePaddingInput=document.getElementById("tilePadding"),this.tileOffsetInput=document.getElementById("tileOffset"),this.fillColorInput=document.getElementById("fillColor"),this.borderColorInput=document.getElementById("borderColor"),this.borderWidthInput=document.getElementById("borderWidth"),this.detailedColorModeCheckbox=document.getElementById("detailedColorMode"),this.detailedColorSettings=document.getElementById("detailedColorSettings"),this.borderColorGroup=document.getElementById("borderColorGroup"),this.borderColorTopInput=document.getElementById("borderColorTop"),this.borderColorBottomInput=document.getElementById("borderColorBottom"),this.borderColorLeftInput=document.getElementById("borderColorLeft"),this.borderColorRightInput=document.getElementById("borderColorRight"),this.borderColorCornerInput=document.getElementById("borderColorCorner"),this.saveTemplateBtn=document.getElementById("saveTemplateBtn"),this.spriteInput=document.getElementById("spriteInput"),this.autoAdjustBtn=document.getElementById("autoAdjustBtn"),this.saveAdjustedBtn=document.getElementById("saveAdjustedBtn"),this.templateCanvas=document.getElementById("templateCanvas"),this.originalCanvas=document.getElementById("originalCanvas"),this.adjustedCanvas=document.getElementById("adjustedCanvas")}bindEvents(){this.saveTemplateBtn.addEventListener("click",()=>this.saveTemplate()),this.spriteInput.addEventListener("change",o=>this.loadSprite(o)),this.autoAdjustBtn.addEventListener("click",()=>this.autoAdjust()),this.saveAdjustedBtn.addEventListener("click",()=>this.saveAdjusted()),this.detailedColorModeCheckbox.addEventListener("change",()=>{this.toggleDetailedColorSettings(),this.generateTemplate()}),[this.tileFormatSelect,this.tileSizeInput,this.tilePaddingInput,this.tileOffsetInput,this.fillColorInput,this.borderColorInput,this.borderWidthInput,this.borderColorTopInput,this.borderColorBottomInput,this.borderColorLeftInput,this.borderColorRightInput,this.borderColorCornerInput].forEach(o=>{o.addEventListener("change",()=>this.generateTemplate())})}toggleDetailedColorSettings(){this.detailedColorModeCheckbox.checked?(this.detailedColorSettings.classList.remove("hidden"),this.borderColorGroup.classList.add("hidden")):(this.detailedColorSettings.classList.add("hidden"),this.borderColorGroup.classList.remove("hidden"))}getConfig(){const t=parseInt(this.tileSizeInput.value)||64,o=parseInt(this.borderWidthInput.value)||10,e=this.detailedColorModeCheckbox.checked,i={tileFormat:parseInt(this.tileFormatSelect.value),tileSize:t,padding:parseInt(this.tilePaddingInput.value)||0,offset:parseInt(this.tileOffsetInput.value)||0,fillColor:I.hexToColor(this.fillColorInput.value),borderColor:I.hexToColor(this.borderColorInput.value),borderWidth:Math.min(o,Math.floor(t/2)),detailedColorMode:e};return e&&(i.detailedColors={top:I.hexToColor(this.borderColorTopInput.value),bottom:I.hexToColor(this.borderColorBottomInput.value),left:I.hexToColor(this.borderColorLeftInput.value),right:I.hexToColor(this.borderColorRightInput.value),corner:I.hexToColor(this.borderColorCornerInput.value)}),i}generateTemplate(){const t=this.getConfig(),o=new M(t);this.templateProcessor=o.generate(),this.renderPreviewWithBackground(this.templateProcessor,this.templateCanvas,t)}saveTemplate(){if(!this.templateProcessor){alert("テンプレートを生成してください");return}const o=`sprite_template_${this.tileFormatSelect.value}tiles.png`;this.templateProcessor.downloadAsFile(o)}async loadSprite(t){var i;const e=(i=t.target.files)==null?void 0:i[0];if(e)try{const s=URL.createObjectURL(e),a=await I.loadImage(s);this.originalProcessor=await I.fromImage(a),URL.revokeObjectURL(s);const n=this.getConfig();this.renderPreviewWithBackground(this.originalProcessor,this.originalCanvas,n),this.adjustedProcessor=null,this.clearCanvas(this.adjustedCanvas)}catch(s){console.error("Failed to load image:",s),alert("画像の読み込みに失敗しました")}}autoAdjust(){if(!this.originalProcessor){alert("スプライトシート画像を読み込んでください");return}const t=this.getConfig(),e=new X(t).adjustWithContentDetection(this.originalProcessor);this.adjustedProcessor=e.processor,this.renderPreviewWithBackground(this.adjustedProcessor,this.adjustedCanvas,t),console.log("Adjustments:",e.adjustments)}saveAdjusted(){if(!this.adjustedProcessor){alert("自動調整を実行してください");return}const o=`sprite_adjusted_${this.tileFormatSelect.value}tiles.png`;this.adjustedProcessor.downloadAsFile(o)}renderPreviewWithBackground(t,o,e){const i=M.getDimensions(e),s=t.getWidth(),a=t.getHeight(),n=Math.max(i.width,s),l=Math.max(i.height,a);o.width=n,o.height=l;const c=o.getContext("2d");c&&(c.fillStyle="#3a3a3a",c.fillRect(0,0,n,l),c.drawImage(t.getCanvas(),0,0),this.drawGridOnCanvas(c,e,s,a))}drawGridOnCanvas(t,o,e,i){const{tileFormat:s,tileSize:a,padding:n,offset:l}=o,c=s===16?4:8,g=s===16?4:6;t.strokeStyle="rgba(128, 128, 128, 0.7)",t.lineWidth=1;for(let h=0;h<=c;h++){const d=l+h*(a+n);d>=0&&d<=e&&(t.beginPath(),t.moveTo(d+.5,0),t.lineTo(d+.5,i),t.stroke())}for(let h=0;h<=g;h++){const d=l+h*(a+n);d>=0&&d<=i&&(t.beginPath(),t.moveTo(0,d+.5),t.lineTo(e,d+.5),t.stroke())}}clearCanvas(t){const o=t.getContext("2d");o&&o.clearRect(0,0,t.width,t.height)}}document.addEventListener("DOMContentLoaded",()=>{new Y});
